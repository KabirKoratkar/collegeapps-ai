<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Verified - CollegeApps.ai</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@700;800&display=swap"
        rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/pages.css">

    <!-- Theme Initialization -->
    <script>
        (function () {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
</head>

<body>
    <div class="auth-container">
        <div class="auth-card" style="text-align: center; max-width: 450px;">
            <div style="font-size: 5rem; margin-bottom: var(--space-xl); animation: bounce 2s infinite;">âœ¨</div>

            <div class="auth-title">
                <h1
                    style="font-size: var(--text-3xl); margin-bottom: var(--space-sm); font-family: 'Outfit', sans-serif;">
                    Email Verified!</h1>
                <p style="color: var(--gray-600); margin-bottom: var(--space-2xl); font-size: var(--text-md);">
                    Your account is now ready to go.
                </p>
            </div>

            <div class="card"
                style="background: var(--gray-50); border: 1px dashed var(--primary-blue); padding: var(--space-xl); margin-bottom: var(--space-2xl);">
                <p style="margin: 0; color: var(--gray-800); font-weight: 500;">
                    You can close this tab now.
                </p>
                <p style="margin: 8px 0 0; font-size: var(--text-sm); color: var(--gray-500);">
                    The original window has already been updated to take you to the next step.
                </p>
            </div>

            <button onclick="window.close()" class="btn btn-primary" style="width: 100%; height: 50px;">Close This
                Tab</button>
            <p style="margin-top: var(--space-lg); font-size: var(--text-xs); color: var(--gray-400);">
                If the original tab didn't update, <a href="onboarding.html"
                    style="color: var(--primary-blue); font-weight: 600;">click here</a> to continue manually.
            </p>
        </div>
    </div>

    <script type="module">
        import { supabase } from './js/supabase-config.js';

        // Create a broadcast channel as backup
        const authChannel = new BroadcastChannel('auth_verification');

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Verifying session...');

            // 1. Wait for Supabase to parse URL hash (tokens)
            // Increased delay slightly for slower devices
            await new Promise(r => setTimeout(r, 1200));

            const { data, error } = await supabase.auth.getSession();

            // 2. Set an explicit signal in localStorage that works across ALL tabs
            // This is the gold standard for cross-tab sync on same origin
            if (data.session) {
                console.log('Session secured! Signaling original tab...');
                localStorage.setItem('verification_signal', Date.now().toString());

                // Also send via channel as secondary
                authChannel.postMessage({ type: 'VERIFICATION_SUCCESS' });
            } else {
                console.log('No session found yet - searching manually in localStorage');
                // Force a final check as sometimes getSession is slow
                const token = Object.keys(localStorage).find(key => key.includes('supabase.auth.token'));
                if (token) {
                    localStorage.setItem('verification_signal', Date.now().toString());
                    authChannel.postMessage({ type: 'VERIFICATION_SUCCESS' });
                }
            }
        });
    </script>

    <style>
        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-20px);
            }

            60% {
                transform: translateY(-10px);
            }
        }
    </style>
</body>

</html>